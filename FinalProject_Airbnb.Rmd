---
title: "Airbnb Final Project"
author: "Divya Khandke and Adam Ghazzawi"
date: "11/22/2020"
output: html_document
---

```{r setup, include=FALSE}
#######################
#LOADING SET UP PART 1
######################
knitr::opts_chunk$set(echo = TRUE)

root.dir = "https://github.com/amghazzawi/airbnb-predictions"

library(tidyverse)
library(tidycensus)
library(sf)
library(spdep)
library(caret)
library(ckanr)
library(FNN)
library(stargazer)
library(grid)
library(gridExtra)
library(ggcorrplot)
library(dplyr)
library(mapview)
library(jtools)
library(ggmap)
library(RColorBrewer)
library(wesanderson)
library(viridis)
library(broom)
library(rmarkdown)
library(knitr)
library(kableExtra)
library(osmdata)

```

```{r warning=FALSE, include=FALSE}
#######################
#LOADING SET UP PART 2
######################
mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2)
  )
}

plotTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle = element_text(face="italic"),
    plot.caption = element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.background = element_rect(fill = "grey80", color = "white"),
    strip.text = element_text(size=12),
    axis.title = element_text(size=12),
    axis.text = element_text(size=10),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"),
    strip.text.x = element_text(size = 14)
  )
}

palettemain <- c("#72b7cd","#cde1b1","#bdc2ab","#cab388","#c3904d","#ff5a5f")
paletteblues <- c( "#7fc3dc","#72b7cd","#2f8caa","#1a81a2","#037499")
paletteorngs <- c("#ceeece","#ebe3a3","#f6cb92","#f6c192","#f6b492") 
               

#Set up quintile breaks for map legends
qBr <- function(df, variable, rnd) {
  if (missing(rnd)) {
    as.character(quantile(round(df[[variable]],0),
                          c(.01,.2,.4,.6,.8), na.rm=T))
  } else if (rnd == FALSE | rnd == F) {
    as.character(formatC(quantile(df[[variable]]), digits = 3),
                 c(.01,.2,.4,.6,.8), na.rm=T)
  }
}

q5 <- function(variable) {as.factor(ntile(variable, 5))}

nn_function <- function(measureFrom,measureTo,k) {
  measureFrom_Matrix <- as.matrix(measureFrom)
  measureTo_Matrix <- as.matrix(measureTo)
  nn <-   
    get.knnx(measureTo, measureFrom, k)$nn.dist
  output <-
    as.data.frame(nn) %>%
    rownames_to_column(var = "thisPoint") %>%
    gather(points, point_distance, V1:ncol(.)) %>%
    arrange(as.numeric(thisPoint)) %>%
    group_by(thisPoint) %>%
    summarize(pointDistance = mean(point_distance)) %>%
    arrange(as.numeric(thisPoint)) %>% 
    dplyr::select(-thisPoint) %>%
    pull()
  
  return(output)  
}
```


```{r, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='all', results='asis'}
#######################
# Data Loading Part 1 
######################
listings <- read_csv("listings.csv")
listings_details <- read_csv("listings_details.csv")
listings_details$price2 = as.numeric(gsub("\\$", "", listings_details$price))

neighborhoods_new <- st_read("neighbourhoods.geojson")

districts <- read_sf("https://maps.amsterdam.nl/open_geodata/geojson.php?KAARTLAAG=GEBIED_STADSDELEN&THEMA=gebiedsindeling") 

neighborhoods <- read_sf("https://maps.amsterdam.nl/open_geodata/geojson.php?KAARTLAAG=GEBIED_BUURTEN&THEMA=gebiedsindeling")

zipcode4 <- read_sf("https://maps.amsterdam.nl/open_geodata/geojson.php?KAARTLAAG=PC4_BUURTEN&THEMA=postcode")

land_use <- read_sf("https://maps.amsterdam.nl/open_geodata/geojson.php?KAARTLAAG=GRONDGEBRUIK_2017&THEMA=grondgebruik")

student_housing <- read_sf("https://maps.amsterdam.nl/open_geodata/geojson.php?KAARTLAAG=JONGERENSTUDENTENHUISVESTING&THEMA=jongerenstudentenhuisvesting")

overnight <- read_sf("https://maps.amsterdam.nl/open_geodata/geojson.php?KAARTLAAG=OVERNACHTINGSBELEID&THEMA=overnachtingsbeleid")

green_roofs <- read_sf("https://maps.amsterdam.nl/open_geodata/geojson.php?KAARTLAAG=GROENE_DAKEN&THEMA=groene_daken")

parks <- st_read("https://maps.amsterdam.nl/open_geodata/geojson.php?KAARTLAAG=PARKPLANTSOENGROEN&THEMA=stadsparken")

farming <- read_sf("https://maps.amsterdam.nl/open_geodata/geojson.php?KAARTLAAG=STADSLANDBOUW_PUNT&THEMA=stadslandbouw")

maj_streets <- read_sf("https://maps.amsterdam.nl/open_geodata/geojson.php?KAARTLAAG=STADSSTRAAT&THEMA=stadsstraat")

metro_lines <- read_sf("https://maps.amsterdam.nl/open_geodata/geojson.php?KAARTLAAG=TRAMMETRO_LIJNEN_2020&THEMA=trammetro")

metro_stops <- read_sf("https://maps.amsterdam.nl/open_geodata/geojson.php?KAARTLAAG=TRAMMETRO_PUNTEN_2020&THEMA=trammetro")

walkability <- read_sf("https://maps.amsterdam.nl/open_geodata/geojson.php?KAARTLAAG=WALKABILITY&THEMA=walkability")

hist_build <- read_sf("https://maps.amsterdam.nl/open_geodata/geojson.php?KAARTLAAG=HISTORISCHE_BEBOUWING&THEMA=archeologie")

wall_art <- read_sf("https://maps.amsterdam.nl/open_geodata/geojson.php?KAARTLAAG=WANDKUNST&THEMA=wandkunst")

barbecue <- read_sf("https://maps.amsterdam.nl/open_geodata/geojson.php?KAARTLAAG=BBQ&THEMA=bbq")

dog_park <- read_sf("https://maps.amsterdam.nl/open_geodata/geojson.php?KAARTLAAG=HONDEN_SPEELPLAATS&THEMA=honden")

markets <- read_sf("https://maps.amsterdam.nl/open_geodata/geojson.php?KAARTLAAG=MARKTEN&THEMA=markten")

playgrounds <- read_sf("https://maps.amsterdam.nl/open_geodata/geojson.php?KAARTLAAG=SPORT_OPENBAAR&THEMA=sport")

swim <- read_sf("https://maps.amsterdam.nl/open_geodata/geojson.php?KAARTLAAG=ZWEMWATER&THEMA=zwemwater")

monuments <- read_sf("https://maps.amsterdam.nl/open_geodata/geojson.php?KAARTLAAG=MONUMENTEN&THEMA=monumenten")

monuments <- monuments[monuments$Soort %in% c("Beeldhouwkunst", "Bouwwerk", "Bouwblok", "Park Terrein"), ]

```


``` {r}
#######################
# Data Loading Part 2 
######################
neighborhoods.sf <- neighborhoods %>%
  st_as_sf(coords = "geometry", crs = 4326, agr = "constant") %>%
  st_transform('EPSG:28992')

neighborhoods_new.sf <- neighborhoods_new %>%
  st_as_sf(coords = "geometry", crs = 4326, agr = "constant") %>%
  st_transform('EPSG:28992')

listings.sf  <- listings %>% 
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326, agr = "constant") %>%
  st_transform(st_crs(neighborhoods.sf))

listings_details.sf  <- listings_details %>% 
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326, agr = "constant") %>%
  st_transform(st_crs(neighborhoods.sf))

listings_details.sf$price2 = as.numeric(gsub("\\$", "", listings_details.sf$price))

#######################
# Neighborhood Plot
######################
ggplot() +
  geom_sf(data = neighborhoods_new.sf, fill = "#2f4550") + 
  geom_sf(data = listings_details.sf, aes(colour = q5(price2)), 
          show.legend = "point", size = .75) +
  scale_colour_manual(values = paletteorngs,
                      labels = qBr(listings_details.sf, "price2"),
                      name = "Nightly Airbnb Price\n(Quintile Breaks)") +
  labs(title="Nightly Airbnb Price, Amsterdam",
       subtitle = "Figure 1") +
  mapTheme()
```


``` {r}
#######################
# District Plot
######################
districts.sf <- districts %>%
  st_as_sf(coords = "geometry", crs = 4326, agr = "constant") %>%
  st_transform('EPSG:28992')

listings_details.sf  <- listings_details.sf %>% 
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326, agr = "constant") %>%
  st_transform(st_crs(districts.sf))

ggplot() +
  geom_sf(data = districts.sf, fill = "black") +
  geom_sf(data = listings_details.sf, aes(colour = q5(price2)), 
          show.legend = "point", size = .75) +
  scale_colour_manual(values = palettemain,
                      labels = qBr(listings_details.sf, "price2"),
                      name = "Nightly Airbnb Price\n(Quintile Breaks)") +
  labs(title="Nightly Airbnb Price, Amsterdam",
       subtitle = "Figure 2") +
  mapTheme()

```

``` {r}
#######################
# Zipcode Plot
######################
zipcode.sf <- zipcode4 %>%
  st_as_sf(coords = "geometry", crs = 4326, agr = "constant") %>%
  st_transform('EPSG:28992')

listings_details.sf  <- listings_details.sf %>% 
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326, agr = "constant") %>%
  st_transform(st_crs(zipcode.sf))

ggplot() +
  geom_sf(data = zipcode.sf, fill = "grey50") +
  geom_sf(data = listings_details.sf, aes(colour = q5(price2)), 
          show.legend = "point", size = .75) +
  scale_colour_manual(values = paletteblues,
                      labels = qBr(listings_details.sf, "price2"),
                      name = "Nightly Airbnb Price\n(Quintile Breaks)") +
  labs(title="Nightly Airbnb Price, Amsterdam",
       subtitle = "Figure 3") +
  mapTheme()
```

``` {r}
#Setting the bounding box to pull in OSM data
xmin = st_bbox(districts)[[1]]
ymin = st_bbox(districts)[[2]]
xmax = st_bbox(districts)[[3]]  
ymax = st_bbox(districts)[[4]]

# Bars
bar <- opq(bbox = c(xmin, ymin, xmax, ymax)) %>%
  add_osm_feature(key = 'amenity', value = c("bar", "biergarten", "pub")) %>%
  osmdata_sf()
bar <-
  bar$osm_points %>%
  .[districts,]

# Restaurants
restaurant <- opq(bbox = c(xmin, ymin, xmax, ymax)) %>%
  add_osm_feature(key = 'amenity', value = c("restaurant", "cafe")) %>%
  osmdata_sf()
restaurant <-
  restaurant$osm_points %>%
  .[districts,]

ggplot() +
  geom_sf(data=districts, fill="black") +
  geom_sf(data=restaurant, colour="#72b7cd", size=.75) +
  geom_sf(data=bar, colour="#ff5a5f", size=.75)


university <- opq(bbox = c(xmin, ymin, xmax, ymax)) %>%
  add_osm_feature(key = 'amenity', value = c("university", "college")) %>%
  osmdata_sf()
university <-
  university$osm_points %>%
  .[districts,]

ggplot() +
  geom_sf(data=districts, fill="black") +
  geom_sf(data=university, colour="blue", size=.75) 

## Schools
schools <- opq(bbox = c(xmin, ymin, xmax, ymax)) %>%
  add_osm_feature(key = 'amenity', value = c("school")) %>%
  osmdata_sf()
schools <-
  schools$osm_points %>%
  .[districts,]

## land use - retail
retail <- opq(bbox = c(xmin, ymin, xmax, ymax)) %>%
  add_osm_feature(key = 'landuse', value = c("retail")) %>%
  osmdata_sf()
retail <-
  retail$osm_points %>%
  .[districts,]

## stadiums/sports centers
stadiums <- opq(bbox = c(xmin, ymin, xmax, ymax)) %>%
  add_osm_feature(key = 'leisure', value = c("stadium")) %>%
  osmdata_sf()
stadiums <-
  stadiums$osm_points %>%
  .[districts,]

## Parks
parks_osm <- opq(bbox = c(xmin, ymin, xmax, ymax)) %>%
  add_osm_feature(key = 'leisure', value = c("park")) %>%
  osmdata_sf()
parks_osm <-
  parks_osm$osm_points %>%
  .[districts,]

## industrial buildings
industrial <- opq(bbox = c(xmin, ymin, xmax, ymax)) %>%
  add_osm_feature(key = 'building', value = c("industrial")) %>%
  osmdata_sf()
industrial <-
  industrial$osm_points %>%
  .[districts,]

## we can use this for maps for the presentation if we would like
ggplot() +
  geom_sf(data=districts, fill="black") +
  geom_sf(data=parks, colour="blue", size=.75) 

```

```{r install-mapboxapi, eval = FALSE}
#######################
# Mapbox Integration
######################
install.packages("mapboxapi", dependencies = TRUE)
```

```{r install-token, eval = FALSE}
#######################
# Mapbox Tokens
######################
my_token <- "pk.eyJ1IjoiZGtoYW5ka2UiLCJhIjoiY2tnMmI1eDVtMDMwMTJ0cGQwY2NmNGNkNSJ9.kSDKluQUL8p3oIpkX1Qjvg"

library(mapboxapi)
mb_access_token(my_token)

```
* `streets-v11`: [The core Mapbox Streets basemap](https://www.mapbox.com/maps/streets)
* `outdoors-v11`: [A basemap designed for outdoor recreation uses](https://www.mapbox.com/maps/outdoors)
* `light-v10`: [A light, greyscale background suitable for thematic overlay](https://www.mapbox.com/maps/light)
* `dark-v10`: [A dark basemap suitable for thematic overlay](https://www.mapbox.com/maps/dark)
* `satellite-v9`: [A global satellite basemap derived from MODIS, Landsat, & proprietary imagery sources](https://www.mapbox.com/maps/satellite)
* `satellite-streets-v11`: The satellite basemap with a streets overlay


```{r mapbox-map}
#######################
# Mapbox Styling
######################
library(leaflet)
library(mapboxapi)

mapbox_map <- leaflet() %>%
  addMapboxTiles(style_id = "light-v10",
                 username = "mapbox") 

mapbox_map
```

```{r geocode-central amsterdam}
############################
# Mapbox Amsterdam Geocoding
############################
afhaus <- mb_geocode("Westermarkt 20, 1016 GV Amsterdam, Netherlands")

afhaus #takes long lat pair and #tidygeocode package!
```

```{r view-central amsterdam}
#######################
# Mapbox Plot Amsterdam
######################
mapbox_map %>%
  setView(lng = afhaus[1],
          lat = afhaus[2],
          zoom = 12)

```


```{r map-site-neighborhoods map box}
#######################
# Mapbox with Districts
######################
mapbox_map %>%
  addPolygons(data = districts)

```

``` {r}

#Double checking how it looks with Mapview - CAN DELETE
mapview(districts.sf)
```


```{r echo=FALSE, fig.height=7, fig.width=7, message=FALSE, warning=FALSE}
#taking out outlier property types
listings_details = filter(listings_details, 
                               property_type != "Lighthouse" & 
                               property_type != "Earth House" & 
                               property_type != "Nature lodge" & 
                               property_type != "Castle" &
                               property_type != "Tent" &
                               property_type != "Campsite")

listings_details %>% 
  dplyr::select(price2, property_type, room_type) %>%
  gather(Variable, Value, -price2) %>% 
   ggplot(aes(Value, price2)) +
     geom_bar(position = "dodge", stat = "summary", fun.y = "mean", fill ="#7fc3dc", col="#1a81a2", alpha = 0.9 ) +
     facet_wrap(~Variable, ncol = 1, scales = "free") +
  labs(title = "Price as a function of\ncategorical variables", y = "Mean_Price") +
     plotTheme() + theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
Vars <- listings_details.sf %>%
  dplyr::select(price2,
                accommodates, bathrooms, bedrooms, availability_365, number_of_reviews, review_scores_rating, markets_nn1, metrostops_nn2, playgrounds_nn2, metrolines_nn3, histbuild_nn3, monuments_nn3, restaurant_nn3, university_nn1, retail_nn3, industrial_nn1, lagPrice) %>%
  na.omit()


Vars <- st_drop_geometry(Vars)

ggcorrplot(
  round(cor(Vars), 1), 
  p.mat = cor_pmat(Vars),
  colors = c("#037499","light grey","#f6b492"), 
  type="lower",
  insig = "blank") +  
  labs(title = "Correlation across numeric variables",
       subtitle = "Figure 3.1") 
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
numericVars <- 
  select_if(st_drop_geometry(listings_details.sf), is.numeric) %>% na.omit()

ggcorrplot(
  round(cor(numericVars), 1), 
  p.mat = cor_pmat(numericVars),
  colors = c("#25CB10", "white", "#FA7800"),
  type="lower",
  insig = "blank") +  
    labs(title = "Correlation across numeric variables") 
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
avgneighb_price <- 
  listings_details.sf %>% group_by(neighbourhood) %>% summarise(meanprice = mean(price2))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
#Airbnb located in city center neighborhoods
# citycenterlist <- list("Centrum-Oost",
                       # "Centrum-West",
                      # "Zuid",
                      # "IJburg - Zeeburgereiland",
                      # "Oud-Noord",
                       #"De Pijp - Rivierenbuurt"
                      #  )
#listings.sf <- listings.sf %>%
 # mutate(City_Center = neighbourhood %in% citycenterlist)
#listings.sf$City_Center <- ifelse(listings.sf$City_Center == "TRUE", 1, 0)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
#Airbnb provides entire home to tenant
entirehomelist <- list("Entire home/apt"
                        )
listings_details.sf <- listings_details.sf %>%
  mutate(Entire_Home = room_type %in% entirehomelist)
listings_details.sf$Entire_Home <- ifelse(listings_details.sf$Entire_Home == "TRUE", 1, 0)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
listings_details.sf$luxury <- ifelse(grepl("luxur",  ignore.case=TRUE, listings_details.sf$name), "yes", "no") 

listings_details.sf$canal <- ifelse(grepl("canal", ignore.case=TRUE, listings_details.sf$name), "yes", "no") 

listings_details.sf$expamen <- ifelse(grepl("view|terrace|spac|rooftop|loft|roof", ignore.case=TRUE, listings_details.sf$name), "yes", "no") 

listings_details.sf$expcodes <- ifelse(grepl("family|big|light|heart|large|design|pijp|jordaan", ignore.case=TRUE, listings_details.sf$name), "yes", "no") 

listings_details.sf$citycenterdesc <- ifelse(grepl("center|centre",ignore.case=TRUE, listings_details.sf$name), "yes", "no") 

listings_details.sf$cheapcodes <- ifelse(grepl("cozy|cosy|free|room|little|bed|garden|vondelpark", ignore.case=TRUE, listings_details.sf$name), "yes", "no") 
  
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
st_c <- st_coordinates

## Metro Stops
metro_stops.sf <- metro_stops%>%
  st_transform(st_crs(districts.sf)) %>%
  st_as_sf()
metro_stops.sf <- st_join(metro_stops.sf, districts.sf, join = st_intersects, left = FALSE)

listings_details.sf <-
  listings_details.sf %>%
  mutate(
    metrostops_nn2 = nn_function(st_c(st_centroid(listings_details.sf)), st_c(st_centroid(metro_stops.sf)), 2))

## Metro Lines
metro_lines.sf <- metro_lines%>%
  st_transform(st_crs(districts.sf)) %>%
  st_as_sf()
metro_stops.sf <- st_join(metro_lines.sf, districts.sf, join = st_intersects, left = FALSE)

listings_details.sf <-
  listings_details.sf %>%
  mutate(
    metrolines_nn3 = nn_function(st_c(st_centroid(listings_details.sf)), st_c(st_centroid(metro_lines.sf)), 3))

## Swimming Areas
swim.sf <- swim%>%
  st_transform(st_crs(districts.sf)) %>%
  st_as_sf()
swim.sf <- st_join(swim.sf, districts.sf, join = st_intersects, left = FALSE)

listings_details.sf <-
  listings_details.sf %>%
  mutate(
    swim_nn1 = nn_function(st_c(st_centroid(listings_details.sf)), st_c(st_centroid(swim.sf)), 1))


## Wall Art
wall_art.sf <- wall_art%>%
  st_transform(st_crs(districts.sf)) %>%
  st_as_sf()
metro_stops.sf <- st_join(wall_art.sf, districts.sf, join = st_intersects, left = FALSE)

listings_details.sf <-
  listings_details.sf %>%
  mutate(
    wallart_nn3 = nn_function(st_c(st_centroid(listings_details.sf)), st_c(st_centroid(wall_art.sf)), 1))

## Markets
markets.sf <- markets%>%
  st_transform(st_crs(districts.sf)) %>%
  st_as_sf()
markets.sf <- st_join(markets.sf, districts.sf, join = st_intersects, left = FALSE)

listings_details.sf <-
  listings_details.sf %>%
  mutate(
    markets_nn1 = nn_function(st_c(st_centroid(listings_details.sf)), st_c(st_centroid(markets.sf)), 1))

## Playgrounds
playgrounds.sf <- playgrounds %>%
  st_transform(st_crs(districts.sf)) %>%
  st_as_sf()
playgrounds.sf <- st_join(playgrounds.sf, districts.sf, join = st_intersects, left = FALSE)

listings_details.sf <-
  listings_details.sf %>%
  mutate(
    playgrounds_nn2 = nn_function(st_c(st_centroid(listings_details.sf)), st_c(st_centroid(playgrounds.sf)), 2))

## Student Housing
students.sf <- student_housing %>%
  st_transform(st_crs(districts.sf)) %>%
  st_as_sf()
students.sf <- st_join(students.sf, districts.sf, join = st_intersects, left = FALSE)

listings_details.sf <-
  listings_details.sf %>%
  mutate(
    students_nn2 = nn_function(st_c(st_centroid(listings_details.sf)), st_c(st_centroid(students.sf)), 2))

## Historic buildings
hist_build.sf <- hist_build %>%
  st_transform(st_crs(districts.sf)) %>%
  st_as_sf()
hist_build.sf <- st_join(hist_build.sf, districts.sf, join = st_intersects, left = FALSE)

listings_details.sf <-
  listings_details.sf %>%
  mutate(
    histbuild_nn3 = nn_function(st_c(st_centroid(listings_details.sf)), st_c(st_centroid(hist_build.sf)), 3))

## Monumuments
monuments.sf <- monuments %>%
  st_transform(st_crs(districts.sf)) %>%
  st_as_sf()
monuments.sf <- st_join(monuments.sf, districts.sf, join = st_intersects, left = FALSE)

listings_details.sf <-
  listings_details.sf %>%
  mutate(
    monuments_nn3 = nn_function(st_c(st_centroid(listings_details.sf)), st_c(st_centroid(monuments.sf)), 3))

## Bars
bar.sf <- bar %>%
  st_transform(st_crs(districts.sf)) %>%
  st_as_sf()
bar.sf <- st_join(bar.sf, districts.sf, join = st_intersects, left = FALSE)

listings_details.sf <-
  listings_details.sf %>%
  mutate(
    bar_nn2 = nn_function(st_c(st_centroid(listings_details.sf)), st_c(st_centroid(bar.sf)), 2))

## Restaurants
restaurant.sf <- restaurant %>%
  st_transform(st_crs(districts.sf)) %>%
  st_as_sf()
restaurant.sf <- st_join(restaurant.sf, districts.sf, join = st_intersects, left = FALSE)

listings_details.sf <-
  listings_details.sf %>%
  mutate(
    restaurant_nn3 = nn_function(st_c(st_centroid(listings_details.sf)), st_c(st_centroid(restaurant.sf)), 3))

## University
university.sf <- university %>%
  st_transform(st_crs(districts.sf)) %>%
  st_as_sf()
university.sf <- st_join(university.sf, districts.sf, join = st_intersects, left = FALSE)

listings_details.sf <-
  listings_details.sf %>%
  mutate(
    university_nn1 = nn_function(st_c(st_centroid(listings_details.sf)), st_c(st_centroid(university.sf)), 1))

## Schools
schools.sf <- schools %>%
  st_transform(st_crs(districts.sf)) %>%
  st_as_sf()
schools.sf <- st_join(schools.sf, districts.sf, join = st_intersects, left = FALSE)

listings_details.sf <-
  listings_details.sf %>%
  mutate(
    schools_nn2 = nn_function(st_c(st_centroid(listings_details.sf)), st_c(st_centroid(schools.sf)), 2))

## Retail
retail.sf <- retail %>%
  st_transform(st_crs(districts.sf)) %>%
  st_as_sf()
retail.sf <- st_join(retail.sf, districts.sf, join = st_intersects, left = FALSE)

listings_details.sf <-
  listings_details.sf %>%
  mutate(
    retail_nn3 = nn_function(st_c(st_centroid(listings_details.sf)), st_c(st_centroid(retail.sf)), 3))

## Industrial
industrial.sf <- industrial %>%
  st_transform(st_crs(districts.sf)) %>%
  st_as_sf()
industrial.sf <- st_join(industrial.sf, districts.sf, join = st_intersects, left = FALSE)

listings_details.sf <-
  listings_details.sf %>%
  mutate(
    industrial_nn1 = nn_function(st_c(st_centroid(listings_details.sf)), st_c(st_centroid(industrial.sf)), 1))

## bar, restaurant, parks_osm, stadiums, university, schools, retail, industrial
```


``` {r k near price lag}
listings_details.sf <- subset(listings_details.sf, price2 > 0)
listings_details.sf <- subset(listings_details.sf, property_type != "Lighthouse")
listings_details.sf <- subset(listings_details.sf, property_type != "Earth house")

listings_details.sf = filter(listings_details.sf, 
                               property_type != "Lighthouse" & 
                               property_type != "Earth House" & 
                               property_type != "Nature lodge" & 
                               property_type != "Castle" &
                               property_type != "Tent" &
                               property_type != "Campsite")


k_nearest_neighbors = 3
#prices
coords <- st_coordinates(listings_details.sf) 
# k nearest neighbors
neighborList <- knn2nb(knearneigh(coords, k_nearest_neighbors))
spatialWeights <- nb2listw(neighborList, style="W")
listings_details.sf$lagPrice <- lag.listw(spatialWeights, listings_details.sf$price2)
```



```{r correlation plots 1}
st_drop_geometry(listings_details.sf) %>% 
  dplyr::select(price2, histbuild_nn3) %>%
  filter(price2 <= 1000000) %>%
  gather(Variable, Value, -price2) %>% 
  ggplot(aes(Value, price2)) +
  geom_point(shape = 16, size = 4, color= "#72b7cd", alpha = 0.7) + geom_smooth(method = "lm", se=F, colour = "#E86E23") +
  facet_wrap(~Variable, ncol = 3, scales = "free") +
  labs(title = "Price as a function of Average Distance to 
Nearest Three Historical Buildings", caption = "Figure 3") +
  plotTheme()



```


```{r correlation plots 2}

st_drop_geometry(listings_details.sf) %>% 
  dplyr::select(price2, lagPrice) %>%
  filter(price2 <= 1000000) %>%
  gather(Variable, Value, -price2) %>% 
  ggplot(aes(Value, price2)) +
  geom_point(shape = 16, size = 3,color= "#cde1b1", alpha = 0.5) + geom_smooth(method = "lm", se=F, colour = "#E86E23") +
  facet_wrap(~Variable, ncol = 4, scales = "free") +
  labs(title = "Price as a function of Nearest Three Rental Prices", caption = "Figure 3") +
  plotTheme()



```


```{r correlation plots 3}

st_drop_geometry(listings_details.sf) %>% 
  dplyr::select(price2, cheapcodes) %>%
  filter(price2 <= 1000000) %>%
  gather(Variable, Value, -price2) %>% 
  ggplot(aes(Value, price2)) +
  geom_point(shape = 16, size = 4,color= "#f6c192", alpha = 0.5) + geom_smooth(method = "lm", se=F, colour = "#E86E23") +
  facet_wrap(~Variable, ncol = 3, scales = "free") +
  labs(title = "Price as a Function of Existence of Coded Language Affiliated with Cheap Properties", caption = "Figure 3") +
  plotTheme()



```

```{r echo=FALSE, message=FALSE, warning=FALSE}
reg1 <- lm(price2 ~ ., data = st_drop_geometry(listings_details.sf) %>% 
                                 dplyr::select(price2, property_type, accommodates, bathrooms, bedrooms, neighbourhood, room_type, availability_365, number_of_reviews, minimum_nights, Entire_Home, markets_nn1, metrostops_nn2, students_nn2, wallart_nn3, playgrounds_nn2, metrolines_nn3, histbuild_nn3, monuments_nn3, restaurant_nn3, university_nn1, schools_nn2, retail_nn3, industrial_nn1, luxury, lagPrice, canal, expamen, expcodes,citycenterdesc, cheapcodes ))

summary(reg1)
```


`

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Clean up of Rents Dataframe
rents <- subset(listings_details.sf, price2 > 0)
rents <- rents[,colSums(is.na(rents))<nrow(rents)]

(rents <- dplyr::select (rents, price2, property_type, accommodates, bathrooms, bedrooms, neighbourhood, room_type, availability_365, number_of_reviews, minimum_nights, Entire_Home, markets_nn1, metrostops_nn2, students_nn2, wallart_nn3, playgrounds_nn2, metrolines_nn3, histbuild_nn3, monuments_nn3, restaurant_nn3, university_nn1, schools_nn2, retail_nn3, industrial_nn1, luxury, lagPrice, canal, expamen, expcodes,citycenterdesc, cheapcodes))

rents<- na.omit(rents)





# Setting up test and training datasets
set.seed(31357)

inTrain <- caret::createDataPartition( 
  y = rents$price2, 
  p = .70, list = FALSE)

rents.training <- rents[inTrain,] 
rents.test <- rents[-inTrain,]  

# rents.test <- predict(reg.training, newdata = rents.test, na.action = na.pass)



#Multivariate regression
reg.training <- lm(price2 ~ ., data = st_drop_geometry(rents.training) %>% 
             dplyr::select(price2, property_type, accommodates, bathrooms, bedrooms, neighbourhood, room_type, availability_365, number_of_reviews, minimum_nights, Entire_Home, markets_nn1, metrostops_nn2, students_nn2, wallart_nn3, playgrounds_nn2, metrolines_nn3, histbuild_nn3, monuments_nn3, restaurant_nn3, university_nn1, schools_nn2, retail_nn3, industrial_nn1, luxury, lagPrice, canal, expamen, expcodes,citycenterdesc, cheapcodes))

stargazer(
  reg.training,
  type = "text",
  title = "Linear Model Summary Table",
  dep.var.caption = " ",
  dep.var.labels = "Model Features")
```



```{r message=FALSE, warning=FALSE}
rents.test <-
  rents.test %>%
  mutate(Regression = "Baseline Regression",
         price2.Predict = predict(reg.training, rents.test),
         price2.Error = price2.Predict - price2,
         price2.AbsError = abs(price2.Predict - price2),
         price2.APE = (abs(price2.Predict - price2)) / price2.Predict)

ErrorTable <- 
  rents.test %>% 
  dplyr::summarize(Regression = "Baseline Regression",
                   MAE = mean(price2.AbsError, na.rm = T), 
                   MAPE = mean(price2.AbsError, na.rm = T) / mean(price2, na.rm = T)) 

ErrorTable %>% 
  st_drop_geometry %>%
  group_by(Regression) %>%
  arrange(desc(MAE)) %>% 
  kable(caption = "MAE and MAPE for Test Set Data") %>% kable_styling("striped", full_width = F) %>%
  row_spec(1, color = "black", background = "#ceeece")
```

### Cross-validation
The plots below indicate how well our model is predicting home prices in both our training and test set data. The orange line indicates a perfect fit, meaning that our predicted home sale values match those of the actual values. As seen in the bottom right scatterplot, we are almost perfectly predicting home sale prices in accordance with their actual values in our training data. In our testing data, our model slightly over-predicts home prices, but fits fairly close to the line.

```{r fig.height=10, fig.width=30, message=FALSE, warning=FALSE}
reg.training_predict <- predict(reg.training, newdata = rents.test)

rmse.train <- caret::MAE(predict(reg.training), rents.training$price2)
rmse.test <- caret::MAE(reg.training_predict, rents.test$price2)

preds.train <- data.frame(pred   = predict(reg.training),
                          actual = rents.training$price2,
                          source = "training data")
preds.test  <- data.frame(pred   = reg.training_predict,
                          actual = rents.test$price2,
                          source = "testing data")

preds <- rbind(preds.train, preds.test)

ggplot(preds, aes(x = pred, y = actual, color = source)) +
  geom_point() +
  geom_smooth(method = "lm", color = "green") +
  geom_abline(color = "orange") +
  coord_equal() +
  theme_bw() +
  facet_wrap(~source, ncol = 2) +
  labs(title = "Comparing predictions to actual values",
       x = "Predicted Value",
       y = "Actual Value",
       subtitle = "Figure 5.1") +
  theme(
    legend.position = "none"
  )

cat("Train MAE: ", as.integer(rmse.train), " \n","Test MAE: ", as.integer(rmse.test))

glimpse(rents)
```

### Generalizability
We then looked to test the generalizability of our model using a cross-validation test. In this analysis, we split our data into 100 groups - one group acts as the test set with the remaining 99 groups acting as the training set. This process is repeated for each individual group, resulting in 100 "scores" telling us how well our model predicted for each sample of new data. 

Our average MAE of **$329,389.5** is similar to the MAE of our initial test, but our standard deviation of **$67,279.99** suggests there's significant variation across our 100 groups. The histogram in Figure 5.2 below confirms the variation showing a wide distribution of errors. This indicates that our model requires continued refinement in order for it to be generalizable to new housing sale price data.
```{r message=FALSE, warning=FALSE}
fitControl <- trainControl(method = "cv", 
                           number = 100,
                           savePredictions = TRUE)

set.seed(717)
reg1.cv <- 
  train(price2 ~ ., data = st_drop_geometry(rents) %>% 
          dplyr::select(price2, property_type, accommodates, bathrooms, bedrooms, neighbourhood, room_type, availability_365, number_of_reviews, minimum_nights, Entire_Home, markets_nn1, metrostops_nn2, students_nn2, wallart_nn3, playgrounds_nn2, metrolines_nn3, histbuild_nn3, monuments_nn3, restaurant_nn3, university_nn1, schools_nn2, retail_nn3, industrial_nn1, luxury, lagPrice, canal, expamen, expcodes,citycenterdesc, cheapcodes), 
        method = "lm", 
        trControl = fitControl, 
        na.action = na.pass)

reg1.cv 

#Standard Deviation and Histogram of MAE
reg1.cv.resample <- reg1.cv$resample

sd(reg1.cv.resample$MAE)

ggplot(reg1.cv.resample, aes(x=MAE)) + geom_histogram(color = "#ff5a5f", fill = "#f6c192", alpha = .7, bins = 50) + 
  labs(title="Histogram of Mean Average Error Across 100 Folds",
       subtitle = "") +
  plotTheme()
```

``` {r observed v predicted}

preds %>%
  dplyr::select(pred, actual) %>%
  ggplot(aes(pred, actual)) +
  geom_point(size = 1.5, color= "#ceeece") +
  stat_smooth(aes(pred, actual), 
              method = "lm", se = FALSE, size = 3, colour="#f6b492", alpha = 0.5) + 
  stat_smooth(aes(actual, actual), 
              method = "lm", se = FALSE, size = 1, colour="#037499", alpha = 0.5) +
  labs(title="Predicted sale price as a function of observed price",
       subtitle="Blue line represents a perfect prediction; Orange line represents ourprediction") +
  plotTheme() + theme(plot.title = element_text(size = 18, colour = "black")) 


```

